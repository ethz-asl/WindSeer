name: Unit Test
on:
  push:
    branches:
    - 'main'
  pull_request:
    branches:
    - '*'

jobs:
  tests:
    runs-on: [self-hosted, linux]
    strategy:
      fail-fast: false
    container: osrf/ros:noetic-desktop
    steps:
    - name: Check out repository
      uses: actions/checkout@v3
    - name: Install Dependencies
      run: |
        apt update && apt install -y python3-pip
        apt install -y libgdal-dev=3.0.4+dfsg-1build3 libhdf5-dev libnetcdf-dev unzip wget
        apt install -y '^libxcb.*-dev' libx11-xcb-dev libglu1-mesa-dev libxrender-dev libxi-dev libxkbcommon-dev libxkbcommon-x11-dev
        pip3 install scipy scikit-learn pyproj h5py matplotlib GDAL==3.0.4 netCDF4 tqdm pandas 
        pip3 install tensorboard pyulog interpolation mayavi mpl-scatter-density PyQt5 yapf
        pip3 install torch==1.13.1+cpu torchvision==0.14.1+cpu torchaudio==0.13.1 --extra-index-url https://download.pytorch.org/whl/cpu
      shell: bash
    - name: Install Windseer Package
      working-directory: 
      run: |
        pip3 install -e .
        python3 windseer/proj_definitions/install_ch_defs.py
      shell: bash
    - name: Download Testdata
      working-directory: 
      run: |
        wget http://robotics.ethz.ch/~asl-datasets/CI_WindSeerData/testdata.zip --directory-prefix windseer/test/testdata
        unzip windseer/test/testdata/testdata.zip -d windseer/test/testdata/
      shell: bash
    - name: Dataset Test
      working-directory:
      run: |
        python3 windseer/test/test_dataset.py
      shell: bash
    - name: Dataset Processing Test
      working-directory:
      run: |
        python3 windseer/test/test_dataset_processing.py
      shell: bash
